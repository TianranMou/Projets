<!DOCTYPE html>
<html>
    <head>  
        <meta charset='utf-8'>
        <title>Compte</title>
        <link rel="stylesheet" type="text/css" href="css/tpcommon.css">
        <link rel="stylesheet" type="text/css" href="css/slide.css">
        <link rel="stylesheet" type="text/css" href="css/login.css">
        <link rel="stylesheet" type="text/css" href="css/register.css">
        <link rel="stylesheet" type="text/css" href="css/account.css">
        <script src="js/md5.min.js"></script>
        <script src="js/account.js"></script>
    </head>
   
    <body>
        <!-- Nav module start -->
        <div class="hidden header">
            <div class="pr container tc">
                <ul class="hidden style nav">
                    <li><a href='tpindex.html'>Acceuil</a></li>
                    <li><a href="consomationdetail.html" mark="product">Consomation</a></li>
                    <li><a href="nutritionstatistic.html" mark="product">Statistique</a></li>
                    <li><a href="contact.html" mark="product">Contact</a></li>
                    <li class="active"><a href="account.html" mark="product">Compte</a></li>
                </ul>
                <div class="clear"></div> 
                <div class="floatr"></div>
            </div>

            <!--when the screen is small, use a different nav, for mobile phones-->
            <div class="menu clearfix" id="menu_toggle1">
                <span onclick="showmenu()">≡≡</span>
            </div>
            <div class="menubox" id="menubox">
                <span id="index_close" onclick="hidemenu()">x</span>
                <ul class="menus-list">
                    <li class=""><a href='tpindex.html'>Acceuil</a></li>
                    <li><a href="consomationdetail.html" mark="product">Consomation</a></li>
                    <li><a href="nutritionstatistic.html" mark="product">Statistique</a></li>
                    <li><a href="contact.html" mark="product">Contact</a></li>
                    <li><a href="account.html" mark="product">Compte</a></li>
                </ul>
            </div>
        </div>
        <!-- nav module end -->

        <!-- Account Forms Container -->
        <div class="account-container">
            <!-- Welcome message -->
            <div id="welcomeMessage" class="form-container" style="display: none;">
                <h2>Bonjour, <span id="userNameSpan"></span></h2>
                <table id="usersTableBody"></table>
                <form action="../backend/logout.php" method="POST">
                    <button type="submit" class="submit-btn">Se déconnecter</button>
                </form>
            </div>

            <!-- register message -->
            <div id="registerSuccess" class="form-container" style="display: none;">
                <h2>Inscription réussie !</h2>
                <p>Vous pouvez désormais vous connecter avec vos identifiants.</p>
                <button type="button" class="submit-btn" onclick="showLoginForm()">Se connecter</button>
            </div>

            <!-- prompt Need login -->
            <div id="loginPrompt" class="form-container" style="display: none;">
                <h2>Veuillez d'abord vous connecter</h2>
                <button type="button" class="submit-btn" onclick="hideLoginPrompt()">OK</button>
            </div>

            <!-- Form -->
            <div id="loginRegisterForms">
                <div class="form-tabs">
                    <button class="tab-button active" onclick="showForm('login')">Se connecter</button>
                    <button class="tab-button" onclick="showForm('register')">Registre</button>
                </div>

                <!-- Login Form -->
                <div id="loginForm" class="form-container active">
                    <form action="../backend/login.php" method="POST" onsubmit="this.password.value = md5(this.password.value)">
                        <div class="form-group">
                            <label for="login-email">Email</label>
                            <input type="email" id="login-email" name="email" required>
                        </div>
                        <div class="form-group">
                            <label for="login-password">Mot de passe</label>
                            <input type="password" id="login-password" name="password" required>
                            <div id="loginError" class="error-message"></div>
                        </div>
                        <button type="submit" class="submit-btn">Se connecter</button>
                    </form>
                </div>

                <!-- Register Form -->
                <div id="registerForm" class="form-container">
                    <form action="../backend/register.php" method="POST" onsubmit="this.password.value = md5(this.password.value)">
                        <div class="form-group">
                            <label for="surname">Prénom</label>
                            <input type="text" id="surname" name="surname" required>
                        </div>
                        <div class="form-group">
                            <label for="name">Nom</label>
                            <input type="text" id="name" name="name" required>
                        </div>
                        <div class="form-group">
                            <label for="register-email">Email</label>
                            <input type="email" id="register-email" name="email" required>
                            <div class="error-message" id="emailError"></div>
                        </div>
                        <div class="form-group">
                            <label for="register-password">Mot de passe</label>
                            <input type="password" id="register-password" name="password" required>
                        </div>
                        <div class="form-group">
                            <label for="id_sexe">Gendre</label>
                            <select id="id_sexe" name="id_sexe" required>
                                <option value="0">Neutre</option>
                                <option value="1">Homme</option>
                                <option value="2">Femme</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="sport_value">fréquence de sport</label>
                            <select id="sport_value" name="sport_value" required>
                                <option value="" disabled selected>Choisissez votre fréquence de sport</option>
                                <option value="0">Level 0 - Pas du tout</option>
                                <option value="1">Level 1 - Exercice léger 1 à 3 jours par semaine</option>
                                <option value="2">Level 2 - Exercice modéré 3 à 5 jours par semaine</option>
                                <option value="3">Level 3 - Exercice d'intensité 6 à 7 jours par semaine</option>
                                <option value="4">Level 4 - Travail physique ou entraînement deux fois/jour</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="height">Hauteur (cm)</label>
                            <input type="number" 
                                   id="height" 
                                   name="height" 
                                   required 
                                   min="1" 
                                   max="300" 
                                   placeholder="Enter your height in cm">
                        </div>
                        <div class="form-group">
                            <label for="date_of_birth">Date de naissance</label>
                            <input type="date" id="date_of_birth" name="date_of_birth" required>
                        </div>
                        <button type="submit" class="submit-btn">Registre</button>
                    </form>
                </div>
            </div>
        </div>

        <script>
            // Menu show/hide function
            function showmenu(){
                document.getElementById("menubox").style.display="block"
            }
            function hidemenu(){
                document.getElementById("menubox").style.display="none"
            }

            // Form switch function
            function showForm(formType) {
                // Hide all forms
                document.querySelectorAll('.form-container').forEach(form => {
                    form.classList.remove('active');
                });
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.classList.remove('active');
                });

                // Show selected form
                if (formType === 'login') {
                    document.getElementById('loginForm').classList.add('active');
                    document.querySelector('button[onclick="showForm(\'login\')"]').classList.add('active');
                } else {
                    document.getElementById('registerForm').classList.add('active');
                    document.querySelector('button[onclick="showForm(\'register\')"]').classList.add('active');
                }
            }

            function showLoginForm() {
                document.getElementById('registerSuccess').style.display = 'none';
                document.getElementById('loginRegisterForms').style.display = 'block';
                showForm('login');
            }

            function hideLoginPrompt() {
                document.getElementById('loginPrompt').style.display = 'none';
                document.getElementById('loginRegisterForms').style.display = 'block';
                showForm('login');
            }

            // Check login status when loaded
            window.onload = function() {
                checkLoginStatus();
                
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('needLogin') === 'true') {
                    document.getElementById('loginPrompt').style.display = 'block';
                    document.getElementById('loginRegisterForms').style.display = 'none';
                    return;
                }
                
                if (urlParams.get('registered') === 'success') {
                    document.getElementById('loginRegisterForms').style.display = 'none';
                    document.getElementById('registerSuccess').style.display = 'block';
                } else {
                    const error = urlParams.get('error');
                    if (error === 'invalid') {
                        document.getElementById('loginError').innerHTML = 
                            'Invalid email or password. Please try again.';
                        document.getElementById('loginError').style.display = 'block';
                        showForm('login');
                    } else if (error === 'system') {
                        document.getElementById('loginError').innerHTML = 
                            'System error. Please try again later.';
                        document.getElementById('loginError').style.display = 'block';
                        showForm('login');
                    } else if (error === 'email_exists') {
                        document.getElementById('emailError').innerHTML = 
                            'Email already exists. Please use a different email.';
                        document.getElementById('emailError').style.display = 'block';
                        showForm('register');
                    } else {
                        showForm('login'); 
                    }
                }
            };

            // check login status
            function checkLoginStatus() {
                fetch('../backend/check_login_status.php')
                    .then(response => response.json())
                    .then(data => {
                        console.log('Login status:', data);
                        if (data.loggedIn) {
                            document.getElementById('welcomeMessage').style.display = 'block';
                            document.getElementById('loginRegisterForms').style.display = 'none';
                            document.getElementById('userNameSpan').textContent = data.userName;
                            
                            get_userinfo();


                        } else {
                            document.getElementById('welcomeMessage').style.display = 'none';
                            document.getElementById('loginRegisterForms').style.display = 'block';
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            }
        </script>
    </body>
</html>